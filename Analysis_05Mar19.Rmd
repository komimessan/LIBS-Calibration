---
title: "Univariate LIBS Calibration curve"
author: "Komi Messan"
date: "March 5, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
# All packages needed
library(rJava)
library(xlsx)
library(xlsxjars)
library(ggplot2)
library(cowplot)
library(latex2exp)
library(DT) # for datatable
library(pls)  # For Principal Component Regression (PCR) and Partial Least Squares Regression (PLSR)
library(devtools)
library(ggbiplot)
library(openxlsx)
#library(plotly)
#library(tidyverse)
```


# Analysis on Lead data

## Handling the negative intensities 

It is noteworthy to point out that several intensities values are negative due to noises in the data. To process this data, all negative intensities values were treating as missing values in the remaining of the analysis. Thus we have baseline of 0 for the intensities value.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Read in raw data

Raw_lead_0 <- openxlsx::read.xlsx("Lead_raw_data.xlsx", sheet="lead_0_ppm", colNames = TRUE)
Raw_lead_100 <- openxlsx::read.xlsx("Lead_raw_data.xlsx", sheet="lead_100_ppm", colNames = TRUE)
Raw_lead_1000 <- openxlsx::read.xlsx("Lead_raw_data.xlsx", sheet="lead_1000_ppm", colNames = TRUE)
Raw_lead_10000 <- openxlsx::read.xlsx("Lead_raw_data.xlsx", sheet="lead_10000_ppm", colNames = TRUE)
Raw_lead_100000 <- openxlsx::read.xlsx("Lead_raw_data.xlsx", sheet="lead_100000_ppm", colNames = TRUE)
```

The average of each of the nine shots were taken by only considering the positive values using the following function
 
```{r, echo=TRUE, warning=FALSE, message=FALSE}

average <- function(Raw_data){
  isPositive <- function(x) x>=0 # function to extract the positive value
  se <- function(x) sqrt(var(x)/length(x)) # standard error
  n <- dim(Raw_data)[1] # find the length of the data
  (v_m <- rep(NA, n)) # create an empty vector of length n for the mean
  (v_sd <- rep(NA, n)) # create an empty vector of length n for the sd
  
  for (i in 1:n){
    v_m[i] <- mean(Filter(isPositive, as.numeric(Raw_data[i,-1])))
    v_sd[i] <- sd(Filter(isPositive, as.numeric(Raw_data[i,-1])))
  }
  v_m[is.na(v_m)] <- 0
  v_sd[is.na(v_sd)] <- 0
   return(data.frame(v_m,v_sd))
}

```



```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Take the average of all nine LIBS shots
mean_lead_0 <- average(Raw_lead_0)$v_m
mean_lead_100 <- average(Raw_lead_100)$v_m
mean_lead_1000 <- average(Raw_lead_1000)$v_m
mean_lead_10000 <- average(Raw_lead_10000)$v_m
mean_lead_100000 <- average(Raw_lead_100000)$v_m

Lead_Data_mval <- data.frame(Raw_lead_0$Wavelength, mean_lead_0,mean_lead_100,
                             mean_lead_1000, mean_lead_10000, 
                             mean_lead_100000)

Intensity_mval <- c(mean_lead_0,mean_lead_100, mean_lead_1000, mean_lead_10000, mean_lead_100000)

Conc <- c(rep("Concentration = 0 ppm",12288),
                          rep("Concentration = 100 ppm",12288),
                          rep("Concentration = 1000 ppm",12288),
                          rep("Concentration = 10000 ppm",12288),
                          rep("Concentration = 100000 ppm",12288))
Wavelength <- rep(Raw_lead_0$Wavelength,5)

Lead_mval <- data.frame(Wavelength, Intensity_mval,Conc) # Wavelength and Conc are in previous block code

```
 
 
 
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=8}
# plot The LIBS Spectra at different concentration

black.bold.text1 <- element_text(face = "bold", color = "black",size=18) # x and y axis
black.bold.text2 <- element_text(face = "bold", color = "black",size=18) # title

p<-theme(axis.text.x = element_text(face="bold", color="black", size=16),
         axis.text.y = element_text(face="bold", color="black", size=16),
         title=black.bold.text2,axis.title = black.bold.text1, legend.position = "bottom",
         legend.text = element_text(size=18),strip.text.x = element_text(face="bold",size=18))

# Lead_mval[which(Lead_mval$Wavelength>280.1 & Lead_mval$Wavelength<280.2 & Lead_mval$Conc=="Concentration = 0 ppm"),] # to check specific values
Lead_mval2 <- Lead_mval[which(Lead_mval$Wavelength>=200 & Lead_mval$Wavelength<375),] # cut the wavelength at 720

#Lead_mval2 <- Lead_mval[which(Lead_mval$Wavelength>=280 & Lead_mval$Wavelength<285),] 
spec_plot_pb <- ggplot(data = Lead_mval2, aes(x = Wavelength, y = Intensity_mval)) +
  geom_line(size = 0.8) + theme_bw() +
  facet_wrap(~Conc,nrow = 5, ncol = 1, scales = "free_y")+
  xlab("Wavelength (nm)") +
  ylab("Intensity (A.U.)") +  scale_x_continuous(breaks=seq(0,550,25)) +
  scale_y_continuous(breaks=seq(0,14000,2000)) + p

spec_plot_pb
```

## Calibration curve for lead at 280.2 nm

From the access to the National Institute of Standards and Technology (NIST) atomic emission spectrum database, the higher intensity of lead (Pb) occurs at 280.1995 which is approximately equal to 280.2 thus we select 280.249 for our univariate analysis. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.width=8}
# calculate the mean and standard error for the univariate analysis
lamb_pb <- 280.249

m_lead_0 <- average(Raw_lead_0[(Raw_lead_0$Wavelength==lamb_pb),])$v_m
m_lead_100 <- average(Raw_lead_100[(Raw_lead_100$Wavelength==lamb_pb),])$v_m
m_lead_1000 <- average(Raw_lead_1000[(Raw_lead_1000$Wavelength==lamb_pb),])$v_m
m_lead_10000 <- average(Raw_lead_10000[(Raw_lead_10000$Wavelength==lamb_pb),])$v_m
m_lead_100000 <- average(Raw_lead_100000[(Raw_lead_100000$Wavelength==lamb_pb),])$v_m


sd_lead_0 <- average(Raw_lead_0[(Raw_lead_0$Wavelength==lamb_pb),])$v_sd
sd_lead_100 <- average(Raw_lead_100[(Raw_lead_100$Wavelength==lamb_pb),])$v_sd
sd_lead_1000 <- average(Raw_lead_1000[(Raw_lead_1000$Wavelength==lamb_pb),])$v_sd
sd_lead_10000 <- average(Raw_lead_10000[(Raw_lead_10000$Wavelength==lamb_pb),])$v_sd
sd_lead_100000 <- average(Raw_lead_100000[(Raw_lead_100000$Wavelength==lamb_pb),])$v_sd

lead_uni_data <- data.frame(c(m_lead_0,m_lead_100,m_lead_1000,
                              m_lead_10000,m_lead_100000),
                            c(sd_lead_0,sd_lead_100,sd_lead_1000,
                              sd_lead_10000,sd_lead_100000),
                            c(1,100,1000,10000,100000))
colnames(lead_uni_data) <- c("Mean_I","sd","Concentration")

## Plotting

fit_lead <- lm(Mean_I~Concentration, data = lead_uni_data) # Rsquare = 0.6647
 
cali_plot_pb <- ggplot(lead_uni_data, aes(x=Concentration, y=Mean_I)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=Mean_I-sd, ymax=Mean_I+sd), colour="black") +
  scale_x_continuous(label= comma, breaks=c(10,1000,100000), trans = "log10")+
  stat_smooth(method = "lm", col = "red", se= FALSE) +
  xlab("Log(concentration of Pb at 280.2 nm in ppm)") +
  ylab("Intensity (a.u.)") +
  geom_label(x=0.5, y=500, label="R = 0.6647") + 
  theme_bw() + p

cali_plot_pb

```


# Analysis on zinc data

## Handling the negative intensities



```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Read in raw data

Raw_zinc_0 <- openxlsx::read.xlsx("Zinc_raw_data.xlsx", sheet="zinc_0_ppm", colNames = TRUE)
Raw_zinc_100 <- openxlsx::read.xlsx("Zinc_raw_data.xlsx", sheet="zinc_100_ppm", colNames = TRUE)
Raw_zinc_250 <- openxlsx::read.xlsx("Zinc_raw_data.xlsx", sheet="zinc_250_ppm", colNames = TRUE)
Raw_zinc_500 <- openxlsx::read.xlsx("Zinc_raw_data.xlsx", sheet="zinc_500_ppm", colNames = TRUE)
Raw_zinc_1000 <- openxlsx::read.xlsx("Zinc_raw_data.xlsx", sheet="zinc_1000_ppm", colNames = TRUE)
```

Now we take the average of all the nine positive shots by considering only the positive intensities


```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Take the average of all nine LIBS shots
mean_zinc_0 <- average(Raw_zinc_0)$v_m
mean_zinc_100 <- average(Raw_zinc_100)$v_m
mean_zinc_250 <- average(Raw_zinc_250)$v_m
mean_zinc_500 <- average(Raw_zinc_500)$v_m
mean_zinc_1000 <- average(Raw_zinc_1000)$v_m

Zinc_Data_mval <- data.frame(Raw_zinc_0$Wavelength, mean_zinc_0,mean_zinc_100,
                             mean_zinc_250, mean_zinc_500, 
                             mean_zinc_1000)

Zinc_Intensity_mval <- c(mean_zinc_0,mean_zinc_100, mean_zinc_250, mean_zinc_500, mean_lead_1000)

Conc_zinc <- factor(c(rep("Concentration = 0 ppm",12288),
                          rep("Concentration = 100 ppm",12288),
                          rep("Concentration = 250 ppm",12288),
                          rep("Concentration = 500 ppm",12288),
                          rep("Concentration = 1000 ppm",12288)),
                    levels = c("Concentration = 0 ppm",
                               "Concentration = 100 ppm",
                               "Concentration = 250 ppm",
                               "Concentration = 500 ppm",
                               "Concentration = 1000 ppm"))
Wavelength_zinc <- rep(Raw_lead_0$Wavelength,5)

Zinc_mval <- data.frame(Wavelength_zinc, Zinc_Intensity_mval,Conc_zinc) # Wavelength and Conc are in previous block code
colnames(Zinc_mval) <- c("Wavelength","Intensity","Conc")

```




```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=8}

# Zinc_mval[which(Zinc_mval$Wavelength>330 & Zinc_mval$Wavelength<331 & Zinc_mval$Conc=="Concentration = 0 ppm"),] # to check specific values

l_w <-220 # lowest value of wavelength to display
u_w <-550 # upper value of wavelength to display
  
Zinc_mval2 <- Zinc_mval[which(Zinc_mval$Wavelength>=l_w & Zinc_mval$Wavelength<u_w),] # cut the wavelength at 720

spec_plot_zn <- ggplot(data = Zinc_mval2, aes(x = Wavelength, y = Intensity))+
  geom_line(size = 0.8) + theme_bw() +
  facet_wrap(~Conc,nrow = 5, ncol = 1, scales = "free_y")+
  xlab("Wavelength (nm)") +
  ylab("Intensity (A.U.)") +  scale_x_continuous(breaks=seq(0,u_w,50)) +
  scale_y_continuous(breaks=seq(0,10000,2000)) + p

spec_plot_zn

```


## Calibration curve for zinc at 334.50134 nm

From the access to the National Institute of Standards and Technology (NIST) atomic emission spectrum database, the higher intensity of zinc (Zn) occurs at 334.50134 which is approximately equal to 334.5 thus we select 334.534 for our univariate analysis. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.width=8}
# calculate the mean and standard error for the univariate analysis
lamb_zn <- 481.017 #rsqure = 0.3559

#lamb_zn <- 334.534

m_zinc_0 <- average(Raw_zinc_0[(Raw_zinc_0$Wavelength=lamb_zn),])$v_m
m_zinc_100 <- average(Raw_zinc_100[(Raw_zinc_100$Wavelength=lamb_zn),])$v_m
m_zinc_250 <- average(Raw_zinc_250[(Raw_zinc_250$Wavelength=lamb_zn),])$v_m
m_zinc_500 <- average(Raw_zinc_500[(Raw_zinc_500$Wavelength=lamb_zn),])$v_m
m_zinc_1000 <- average(Raw_zinc_1000[(Raw_zinc_1000$Wavelength=lamb_zn),])$v_m


sd_zinc_0 <- average(Raw_zinc_0[(Raw_zinc_0$Wavelength=lamb_zn),])$v_sd
sd_zinc_100 <- average(Raw_zinc_100[(Raw_zinc_100$Wavelength=lamb_zn),])$v_sd
sd_zinc_250 <- average(Raw_zinc_250[(Raw_zinc_250$Wavelength=lamb_zn),])$v_sd
sd_zinc_500 <- average(Raw_zinc_500[(Raw_zinc_500$Wavelength=lamb_zn),])$v_sd
sd_zinc_1000 <- average(Raw_zinc_1000[(Raw_zinc_1000$Wavelength=lamb_zn),])$v_sd

zinc_uni_data <- data.frame(c(m_zinc_0,m_zinc_100,m_zinc_250,
                              m_zinc_500,m_zinc_1000),
                            c(sd_zinc_0,sd_zinc_100,sd_zinc_250,
                              sd_zinc_500,sd_zinc_1000),
                            c(0,100,250,500,1000))
colnames(zinc_uni_data) <- c("Mean_I","sd","Concentration")

## Plotting
summary(lm(Mean_I~Concentration, data = zinc_uni_data))

fit_zinc <- lm(Mean_I~Concentration, data = zinc_uni_data) # Rsquare = 0.0574

cali_plot_zn <- ggplot(zinc_uni_data, aes(x=Concentration, y=Mean_I)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=Mean_I-sd, ymax=Mean_I+sd), colour="black") +
  scale_x_continuous(label= comma) +
  stat_smooth(method = "lm", col = "red", se= FALSE) +
  xlab("concentration of Zn at 334.5 nm in ppm") +
  ylab("Intensity (a.u.)") +
  geom_label(x=0.2, y=200, label="R = 0.7364") + 
  theme_bw() + p

cali_plot_zn

```




